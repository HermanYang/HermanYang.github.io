<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Tensorflow Profiler</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Tensorflow Profiler" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Class Hierachy Event Collector ```puml enum EventCategory { ShceduleClosure RunClosure Compute }" />
<meta property="og:description" content="Class Hierachy Event Collector ```puml enum EventCategory { ShceduleClosure RunClosure Compute }" />
<link rel="canonical" href="http://localhost:4000/tensorflow/2020/06/08/tensorflow-profiler.html" />
<meta property="og:url" content="http://localhost:4000/tensorflow/2020/06/08/tensorflow-profiler.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-08T21:11:29+08:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/tensorflow/2020/06/08/tensorflow-profiler.html"},"@type":"BlogPosting","url":"http://localhost:4000/tensorflow/2020/06/08/tensorflow-profiler.html","headline":"Tensorflow Profiler","dateModified":"2020-06-08T21:11:29+08:00","datePublished":"2020-06-08T21:11:29+08:00","description":"Class Hierachy Event Collector ```puml enum EventCategory { ShceduleClosure RunClosure Compute }","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/"></a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tensorflow Profiler</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-08T21:11:29+08:00" itemprop="datePublished">Jun 8, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="class-hierachy">Class Hierachy</h2>
<p><strong>Event Collector</strong></p>
<pre><code class="language-puml">enum EventCategory {
  ShceduleClosure
  RunClosure
  Compute
}

class EventCollector {
  + isEnabled()
  + RecordEvent()
  + SetCurrentThreadName()
  + StartRegin()
  + StopRegion()
}

class ScopeRegion {
  + ScopeRegion()
  + ~ScopeRegion()
}

ScopeRegion o-- EventCollector
</code></pre>

<p><strong>GPU Device Tracerr</strong></p>
<pre><code class="language-puml">class DeviceInfo {
  int ordinal
  string name
  int num_contexts
}

class ContextInfo {
  int index
  DeviceInfo dev_info
  int num_streams
  CUevent end_event
}

class StreamInfo {
  string name
  int index
  Contextinfo ctx_info
}

class CudaEventCollector {
  + AddStreamInfo(context, stream, name)
  + Collect()
  + CudaEventCollector
  + GetContextInfo
  + GetElapsedTimeUs
  + GetMemcpyName
  + InitializedDeviceInfos()
  + SaveRecord(record)
  + SaveStats()
  + Synchronize()
}

class CudaEventRecorder {
    ConsumeKernelRecords()
    ConsumeMemcpyRecords()
    StartKernel()
    StartMemcpy()
    StopKernel()
    StopMemcpy()
}

class CuptiCallbackHook {
  CuptiCallback()
  CuptiCallbackHook()
  DriverApiEnterCallback
  DriverApiExitCallback
  Enable
  GetMemoryType
  StartMemcpy
  StartMemcpyAsync
}

class StepStatsCollector
class ProfilerInterface
class DeviceTracer {
  + Start()
  + Stop()
  + CollectData(RunMetadata)
}

ProfilerInterface &lt;|-- DeviceTracer 

StreamInfo o-- ContextInfo
ContextInfo o-- DeviceInfo
CudaEventCollector o-- StreamInfo
CudaEventCollector o-- CudaEventRecorder 
CudaEventCollector o-- StepStatsCollector
DeviceTracer o-- CuptiCallbackHook
DeviceTracer o-- CudaEventCollector
</code></pre>

<p><strong>MLU Device Tracer</strong></p>
<pre><code class="language-puml">class MallocDetails {
  uint64 num_bytes
}

class MemcpyDetails {
    size num_bytes
    Dir direction
    bool async
}

class MemcpyPeerDetails {
  size num_bytes
  int src_device
  int dst_device
}

enum CnpapiTracerEventType {
  Unsupported
  kernel
  memcpyPeer
  MemoryAlloc
  Generic
}

enum CnpapiTracerEventSource {
  Callback
  Activity
  Notifier
}

class KernelDetails{
  string kernel_name
}

class CnpapiTracerEvent {
  CnpapiTracerEventType type
  CnpapiTracerEventSource source
  string name
  uint64 start_time_ns
  uint64 end_time_ns
  uint64 schedule_time_ns
  uint32 device_id
  uint32 thread_id
  string anotation
  KernelDetails kernel_details
  MemcpyDetails memcpy_details
  MemcpyPeerDetail memcpy_peer_details
  MallocDetails malloc_details
}

class CnpapiTracerOptions {
  bool enable_activity_api
  bool enable_event_based_activity
  bool required_callback_api_events
  vector cnml_cbids_selected
  vector cnrt_cbids_selected
  vector activities_selected
  bool cnpapi_finalize
}

class CnpapiInterface {

}

class CnpapiLoader {

}

class CnpapiWrapper {
  CnpapiLoader cnpapi_loder
}

class CnpapiTracer {
  CnpapiSopaApiHook cnpapi_sopa_api_hook_
  cnpapi_SubscriberHandler subscripber_
  CnpapiInterface cnpapi_interface_
  CnpapiTracerCollector collector_
}

interface ProfilerInterface {
  +Start()
  +Stop()
  +CollectData(RunMetadata* )
}

class MLUTracer {
  CnpapiTracer cnpapi_tracer
  CnpapiTracerOptions options
  CnpapiTracerCollectorImpl cnpapi_collector
}

interface CnpapiTracerCollector {
  +void AddEvent(CnpapiTracerEvent&amp;&amp;)
  +void onEventsDropped(string reason, uint32 num_events)
  +void Flush()
  +AnootationMap* annotation_map()
  +uint32 GetDeviceId(Dev dev)
}

class CnpapiTracerCollectorImpl {

}

class CnpapiSopaApiHookWithDeviceEvent {
  collector_
  options_
  sopa_vent_recorder_
  Fulsh()
  OnSopaApiEnter()
  OnSopaApiExit()
}

class CnpapiSopaApiHookWithHostEvent {
  collector_
  options_
  sopa_vent_recorder_
  Fulsh()
  OnSopaApiEnter()
  OnSopaApiExit()
}

class CssnpapiApiTracingDisabler {

}

class SopaEventRecorder{
  CreateAndPlaceNotifier(MLUCnrtNotifier **, MLUCnrtQueue *)
  Flush()
  RecordEvent(const EventRecord &amp;)
  SaveRecord(const EventRecord &amp;)
}

class EventRecord {
  CnpapiTracerEventType type
  string name
  uint64 start_timestamp
  MLUCnrtQueue* queue
  MLUCnrtNotifier* start_notifier
  MLUCnrtNotifier* end_notifier
  uint32 device_id
  uint32 thread_id
  string anotation
  KernelDetails kernel_details
  MemcpyDetails memcpy_details
}

class QueueInfo {
   uint64 end_walltime_us
   bool synchronized 
   MLUCnrtNotifier end_notifier
}

class AnnotationStack {
  +static PushAnnotation(name)
  +static PopAnnotation(name)
  static* 
}

CnpapiTracer o-- CnpapiTracerCollector
CnpapiTracer o-- CnpapiInterface
CnpapiTracerEvent o-- CnpapiTracerEventType
CnpapiTracerEvent o-- CnpapiTracerEventSource
CnpapiTracerEvent o-- KernelDetails
CnpapiTracerEvent o-- MemcpyDetails
CnpapiTracerEvent o-- MemcpyPeerDetails
CnpapiTracerEvent o-- MallocDetails
CnpapiInterface &lt;|-- CnpapiWrapper 
CnpapiWrapper o-- CnpapiLoader
MLUTracer o-- CnpapiTracer
MLUTracer o-- CnpapiTracerOptions
MLUTracer o-- CnpapiTracerCollectorImpl
ProfilerInterface &lt;|-- MLUTracer 
CnpapiTracerCollector &lt;|-- CnpapiTracerCollectorImpl
</code></pre>

<h2 id="tensorflow-profiing-sequences">Tensorflow Profiing Sequences</h2>
<h3 id="local-session">Local Session</h3>
<p><strong>1. Overall</strong></p>
<pre><code class="language-puml">@startuml
"DirectSession::RunInternal" -&gt; ProfilerSession: Create
ProfilerSession -&gt; HostTracer: Create
ProfilerSession -&gt; DeviceTracer: Create
ProfilerSession -&gt; HostTracer: Start
ProfilerSession -&gt; DeviceTracer: Start
"DirectSession::RunInternal" -&gt; StepStatsCollector: new
"DirectSession::RunInternal" -&gt; ProfilerSession: CollectData
loop 
"DirectSession::RunInternal" -&gt; ExecutorState: Process
"ExecutorState" -&gt; NodeExecStats: SetExecutorStarted
"ExecutorState" -&gt; NodeExecStats: SetScheduled
"ExecutorState" -&gt; NodeExecStats: SetComputeStarted
"ExecutorState" -&gt; Device: Compute
"ExecutorState" -&gt; NodeExecStats: SetComputeEnded
"ExecutorState" -&gt; NodeExecStats: SetMemory
"ExecutorState" -&gt; NodeExecStats: SetexecutorEnded
end
"DirectSession::RunInternal" -&gt; StepStatsCollector: Finalize
StepStatsCollector -&gt; NodeExecStats: Finalize
"DirectSession::RunInternal" -&gt; ProfilerSession: Destruction
ProfilerSession -&gt; Profiler: Stop
@enduml
</code></pre>
<p><strong>2. Memory Profiling</strong></p>

<pre><code class="language-puml">enum AllocRecord {
  int alloc_bytes
  int alloc_micros
}
</code></pre>

<pre><code class="language-puml">ExecutorState -&gt; Device: Compute
Device -&gt; OpKernel: Compute
OpKernel -&gt; TrackingAllocator: Create
Device -&gt; TrackingAllocator: AllocateRaw
TrackingAllocator -&gt; TrackingAllocator: AddAllocateRecord
Device -&gt; TrackingAllocator: DeallocateRaw
TrackingAllocator -&gt; TrackingAllocator: AddAllocateRecord
ExecutorState -&gt; NodeExecStats: SetMemory
NodeExecStats -&gt; OpKernel: ConsumeWrappedAllocators
</code></pre>

<p><strong>2. Activity/ScropedRegion/Annotation</strong>
For Compute, Run Closure events</p>
<pre><code class="language-puml">ScopeRegion -&gt; EventCollector:StartRegion
ScopeRegion -&gt; EventCollector:StopRegion
</code></pre>

<p>Any General Code sn</p>
<pre><code class="language-puml">TraceMe -&gt; TraceMeRecorder:Record
</code></pre>

<pre><code class="language-puml">ScopedAnnotation -&gt; Annotation:PushAnnotation
ScopedAnnotation -&gt; Annotation:PopAnnotation
Annotation -&gt; "Thread Local":ThreadAnnotation
XXX -&gt; Annotation:CurrentAnnotation
</code></pre>
<p><strong>3. GPU Profiler</strong></p>

<p>LaunchKernel,
Memcpy
MemcpyAsync
MemcpyHtoD
MemcpyHtoDAsync
MemcpyDtoH
MemcpyDtoHAsync
MemcpyDtoD
MemcpyDtoDAsync</p>

<pre><code class="language-puml">ProfileSession -&gt; DeviceTracer: Start
DeviceTracer -&gt; ScoptedAnnotation: Enbale
DeviceTracer -&gt; CuptiCallbackHook: new
CuptiCallbackHook -&gt; CUPTI: cputiSubscribe
CuptiCallbackHook -&gt; CUPTI: cputiEnbaleCallback
CUPTI -&gt; CuptiCallbackHook: CuptiCallback
CuptiCallbackHook -&gt; CuptiCallbackHook: DriverApiEnterCallback
CuptiCallbackHook -&gt; CudaEventRecorder: StartKernel/StartMemcpy/StopKernel/StopMemcpy
CudaEventRecorder -&gt; Annotation: CurrentAnnocation
ProfileSession -&gt; DeviceTracer: CollectData
DeviceTracer -&gt; CudaEventCollector: Collect
CudaEventCollector -&gt; CudaEventRecorder: ConsumeKernelRecords
CudaEventCollector -&gt; CudaEventRecorder: ConsumeMemcpyRecords
CudaEventCollector -&gt; StepStatsCollector: Save
</code></pre>
<p><strong>4. MLU Profiler</strong>
cnmlCompileBaseOp
cnmlCompileFusionOp
cnrtInvokeKernel
cnrtInvokeRuntimeContext
cnrtDestroyQueue
cnrtSyncQueue
cnrtMemcpy
cnrtMemcpyPeer
cnrtMalloc
cnrtMemcpyAsync</p>

<pre><code class="language-puml">ProfileSession -&gt; MLUTracer: Create
MLUTracer -&gt; CnpapiInterface: Create
ProfileSession -&gt; MLUTracer: Start
MLUTracer -&gt; CnpapiTracerCollector: new
MLUTracer -&gt; AnnotationStack: Enable
MLUTracer -&gt; CnpapiTracer: Enable
CnpapiTracer -&gt; CnpapiCnApiHookWithDeviceEvent:new
CnpapiTracer -&gt; CnpapiCnApiHookWithHostEvent:new
CnpapiTracer -&gt; CnpapiInterface: Subscribe
CnpapiInterface -&gt; Papi: subscribe
Papi -&gt; CnpapiTracer: HandleCallback
CnpapiTracer -&gt; CnEventRecorder: StarttKernelEvent/StopEvent
CnEventRecorder -&gt; CnEventRecorder: Record Event
ProfileSession -&gt; MLUTracer: CollectData
MLUTracer -&gt; CnpapiTracerCollector: CollectData


ProfileSession -&gt; MLUTracer: Stop
MLUTracer -&gt; AnnotationStack: Disable
MLUTracer -&gt; CnpapiTracer: Disable

</code></pre>

<h3 id="remote-session">Remote Session</h3>

  </div><a class="u-url" href="/tensorflow/2020/06/08/tensorflow-profiler.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name"></li><li><a class="u-email" href="mailto:yxyherman@outlook.com">yxyherman@outlook.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/HermanYang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">HermanYang</span></a></li><li><a href="https://www.twitter.com/HermanYang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">HermanYang</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
