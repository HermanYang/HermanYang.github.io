<h1 id="tensorflow-models-profiler">Tensorflow Models Profiler</h1>

<h2 id="1-背景">1. 背景</h2>

<p>目前推理和训练均有性能统计的需求，性能统计会占用大量人力时间，如果将性能统计功能加入各个模型当中，就能达到快速生成性能统计数据的目的。
为了可以快速和正确地采集性能数据，需要有标准的性能数据采集步骤，集成了这些步骤后，模型需要可方便地关闭性能采集以免影响性能，同时性能采集的代码要尽可能简洁。
为此，封装了性能采集接口，帮助工程师编写模型性能采集功能。</p>

<h2 id="2-性能数据分层">2. 性能数据分层</h2>

<ul>
  <li>应用层：采集模型的数据准备时间，数据后处理时间，程序整体时间等应用层的数据；</li>
  <li>框架层：采集模型算子的性能数据，包括计算时间，消耗内存等；</li>
  <li>运行时层：采集CNRT，CNML，CNNL以及驱动层等运行时的时间消耗；</li>
  <li>硬件层：采集硬件计算时间，硬件利用率，硬件IO状况数据；</li>
</ul>

<p><strong>目前，可以采集到的有应用层，框架层以及部分运行时层的性能数据，硬件层的数据目前仍然无法采集到，需要魔改TF来集成系统工具组的接口。</strong></p>

<h2 id="3-使用方法">3. 使用方法</h2>

<p>1.初始化
Prifler是一个全局单例，在使用前初始化即可；</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">cambricon_example.utils.profiler</span> <span class="kn">import</span> <span class="n">Profiler</span>
  <span class="n">profiler</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">()</span>
</code></pre></div></div>

<p>运行模型前通过控制环境变量打开或者关闭Profile功能</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">TENSORFLOW_MODELS_TRACE_LEVEL</span><span class="o">=</span>2 <span class="c"># 打开Profile功能</span>
<span class="nb">export </span><span class="nv">TENSORFLOW_MODELS_TRACE_LEVEL</span><span class="o">=</span>0 <span class="c"># 关闭Profile功能</span>
</code></pre></div></div>

<p>2.采集应用层数据</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">profiler</span><span class="p">.</span><span class="n">activity_start</span><span class="p">(</span><span class="n">activity_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
  <span class="p">...</span>
  <span class="n">doSomeActivity</span><span class="p">()</span>
  <span class="p">...</span>
  <span class="n">profiler</span><span class="p">.</span><span class="n">activity_end</span><span class="p">(</span><span class="n">activity_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
</code></pre></div></div>

<p>3.采集框架层数据
目前只考虑了两种模型运行方式，一种是Keras运行方式，另一种是普通的Session Run方法。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Keras
</span>  <span class="p">...</span>
  <span class="n">options</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">RunOptions</span><span class="p">(</span><span class="n">trace_level</span> <span class="o">=</span> <span class="n">profiler</span><span class="p">.</span><span class="n">get_tf_trace_level</span><span class="p">())</span>
  <span class="err"></span><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(...,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">,</span> <span class="n">run_metadata</span> <span class="o">=</span> <span class="n">profiler</span><span class="p">.</span><span class="n">get_tf_runmetadata</span><span class="p">(</span><span class="n">graph_name</span><span class="p">))</span>
  <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(...,</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">profiler</span><span class="p">.</span><span class="n">get_collect_runmetadata_callback</span><span class="p">(</span><span class="n">graph_name</span><span class="p">)])</span>
  <span class="p">...</span>
  <span class="n">profiler</span><span class="p">.</span><span class="n">finalize</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Session Run
</span>  <span class="p">...</span>
  <span class="n">options</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">RunOptions</span><span class="p">(</span><span class="n">trace_level</span> <span class="o">=</span> <span class="n">profiler</span><span class="p">.</span><span class="n">get_tf_trace_level</span><span class="p">())</span>
  <span class="n">profiler</span><span class="p">.</span><span class="n">step_start</span><span class="p">(</span><span class="n">graph_name</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
  <span class="n">session</span><span class="p">.</span><span class="n">Run</span><span class="p">(...,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">,</span> <span class="n">run_metadata</span><span class="o">=</span><span class="n">profiler</span><span class="p">.</span><span class="n">get_tf_runmetadata</span><span class="p">(</span><span class="n">graph_name</span><span class="p">))</span>
  <span class="n">profiler</span><span class="p">.</span><span class="n">step_end</span><span class="p">(</span><span class="n">graph_name</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
  <span class="p">...</span>
</code></pre></div></div>

<p>4.生成性能报告</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">profiler</span><span class="p">.</span><span class="n">finalize</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="4-性能报告">4. 性能报告</h2>

<ol>
  <li>生成的目录</li>
</ol>

<p>生成Timeline数据与timeline文件夹，可以查看每个step的timeline数据，数据总结在summary.md文件和summary.json文件里面。</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>profile/
  timeline/
    model_step_0
    model_step_1
    ...
  step_stats/
    model_step_0
    model_step_1
    ...
  summary.json
  summary.md
</code></pre></div></div>

<ol>
  <li>summary.json内容</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"app_stats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"[step]"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"[activity_name]"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"duration"</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="w">
          </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is Vgg session run"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"op_stats"</span><span class="p">:{</span><span class="w">
      </span><span class="nl">"[model]"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"[step]"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"[ip]"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"[device]"</span><span class="p">:{</span><span class="w">
              </span><span class="nl">"[node name]"</span><span class="p">:{</span><span class="w">
                </span><span class="nl">"duration"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"output"</span><span class="p">:{</span><span class="w">
                  </span><span class="nl">"[slot]"</span><span class="p">:{</span><span class="w">
                    </span><span class="nl">"shape"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Int32"</span><span class="w">
                  </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"total_bytes"</span><span class="p">:</span><span class="mi">128</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>vgg16 summary.json 例子</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"app_stats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"0"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"Vgg Session Run"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"duration"</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="w">
          </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is Vgg session run"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"op_stats"</span><span class="p">:{</span><span class="w">
      </span><span class="nl">"vgg16"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"0"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"localhost"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"CPU"</span><span class="p">:{</span><span class="w">
              </span><span class="nl">"op_name"</span><span class="p">:{</span><span class="w">
                </span><span class="nl">"duration"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="nl">"output"</span><span class="p">:{</span><span class="w">
                  </span><span class="nl">"0"</span><span class="p">:{</span><span class="w">
                    </span><span class="nl">"shape"</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">],</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Int32"</span><span class="w">
                  </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"total_bytes"</span><span class="p">:</span><span class="mi">128</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
